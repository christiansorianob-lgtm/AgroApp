generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -----------------------------------------------------------------------------
// 1) FINCAS
// -----------------------------------------------------------------------------
model Finca {
  id              String   @id @default(uuid())
  codigo          String   @unique // FIN-000001
  nombre          String
  departamento    String
  municipio       String
  veredaSector    String
  responsable     String
  areaTotalHa     Float
  latitud         Float?
  longitud        Float?
  poligono        Json?    // Array of {lat, lng} for boundaries
  estado          EstadoFinca @default(ACTIVO)
  observaciones   String?  @db.Text
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relaciones
  lotes           Lote[]
  tareas          Tarea[]
  usosMaquinaria  UsoMaquinaria[]
  movimientosInventario MovimientoInventario[]
  maquinarias     Maquinaria[]
  productos       Producto[]
}

enum EstadoFinca {
  ACTIVO
  INACTIVO
}

// -----------------------------------------------------------------------------
// 2) LOTES
// -----------------------------------------------------------------------------
model Lote {
  id              String   @id @default(uuid())
  codigo          String   // Unico dentro de la finca (manejado por logica app o composite unique)
  fincaId         String
  nombre          String

  tipoCultivo     String
  variedad        String?
  fechaSiembra    DateTime?
  areaHa          Float // Redundant if calculated from polygon, but kept for cache/manual entry
  latitud         Float?
  longitud        Float?
  poligono        Json?    // Array of {lat, lng} for boundaries
  estado          EstadoLote @default(ACTIVO)
  observaciones   String?  @db.Text
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  finca           Finca    @relation(fields: [fincaId], references: [id])
  
  // Relaciones
  tareas          Tarea[]
  usosMaquinaria  UsoMaquinaria[]
  movimientosInventario MovimientoInventario[]

  @@unique([fincaId, codigo]) // Codigo unico por finca
}

enum EstadoLote {
  ACTIVO
  INACTIVO
  EN_RENOVACION
}

// -----------------------------------------------------------------------------
// 3) TAREAS / ACTIVIDADES
// -----------------------------------------------------------------------------
model Tarea {
  id                  String   @id @default(uuid())
  codigo              String   @unique // TAR-000001
  fincaId             String
  loteId              String?  // Nullable si es NivelTarea = FINCA
  nivel               NivelTarea
  fechaProgramada     DateTime
  fechaInicioReal     DateTime? // Fecha cuando se dio click a "Iniciar"
  fechaEjecucion      DateTime? // Fecha cuando se dio click a "Finalizar"
  tipo                String // Fertilización, Plateo, etc. (Puede ser Enum o String libre)
  descripcion         String?  @db.Text
  responsable         String
  duracionEstimadaHoras Float?
  duracionRealHoras   Float?
  estado              EstadoTarea @default(PROGRAMADA)
  prioridad           PrioridadTarea @default(MEDIA)
  evidencias          String?  // URLs o Texto
  requiereTrazabilidad Boolean @default(false)
  observaciones       String?  @db.Text
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  finca               Finca    @relation(fields: [fincaId], references: [id])
  lote                Lote?    @relation(fields: [loteId], references: [id])

  // Relaciones
  usosMaquinaria      UsoMaquinaria[]
  consumos            MovimientoInventario[]
  trazabilidad        Trazabilidad[]
}

model Trazabilidad {
  id        String   @id @default(uuid())
  tareaId   String
  lat       Float
  lng       Float
  accuracy  Float?
  battery   Float?
  timestamp DateTime
  createdAt DateTime @default(now())

  tarea     Tarea    @relation(fields: [tareaId], references: [id])
}

enum NivelTarea {
  FINCA
  LOTE
}

enum EstadoTarea {
  PROGRAMADA
  EN_PROCESO
  EJECUTADA
  CANCELADA
}

enum PrioridadTarea {
  BAJA
  MEDIA
  ALTA
}

// -----------------------------------------------------------------------------
// 4) MAQUINARIA
// -----------------------------------------------------------------------------
model Maquinaria {
  id                      String   @id @default(uuid())
  codigo                  String   @unique // MAQ-000, MAQ-001 (Autogenerado)
  
  // Relations to Catalogs
  tipoMaquinariaId        String
  marcaMaquinariaId       String
  ubicacionMaquinariaId   String
  
  // Finca relation might still be useful if the machine belongs to a specific Finca entity, 
  // but user asked for "Ubicacion" to be a dropdown of "Bodega, Taller". 
  // We will keep fincaId as nullable if we want to track ownership, or strictly follow "Ubicacion" as the new location.
  // Given "Ubicacion (Finca Base)" -> "Ubicacion" request, I will treat ubicacionMaquinariaId as the primary location info.
  // I will keep fincaId optional for now to not break existing data immediately, or just remove if I am sure.
  // Plan said "Make fincaId optional". 
  fincaId                 String
  
  modelo                  String
  serialPlaca             String
  fechaCompra             DateTime?
  estado                  EstadoMaquinaria @default(DISPONIBLE)
  horometroActual         Float?
  ultimoMantenimiento     DateTime?
  observaciones           String?  @db.Text
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  tipo        TipoMaquinaria      @relation(fields: [tipoMaquinariaId], references: [id])
  marca       MarcaMaquinaria     @relation(fields: [marcaMaquinariaId], references: [id])
  ubicacion   UbicacionMaquinaria @relation(fields: [ubicacionMaquinariaId], references: [id])
  finca       Finca               @relation(fields: [fincaId], references: [id])

  usos UsoMaquinaria[]
}

enum EstadoMaquinaria {
  DISPONIBLE
  EN_USO
  EN_MANTENIMIENTO
  FUERA_DE_SERVICIO
  PRESTADA
  EN_TRASLADO
}

// -----------------------------------------------------------------------------
// CATALOGOS MAQUINARIA
// -----------------------------------------------------------------------------
model TipoMaquinaria {
  id        String       @id @default(uuid())
  nombre    String       @unique
  maquinas  Maquinaria[]
}

model MarcaMaquinaria {
  id        String       @id @default(uuid())
  nombre    String       @unique
  maquinas  Maquinaria[]
}

model UbicacionMaquinaria {
  id        String       @id @default(uuid())
  nombre    String       @unique
  maquinas  Maquinaria[]
}

// -----------------------------------------------------------------------------
// 5) USO_MAQUINARIA
// -----------------------------------------------------------------------------
model UsoMaquinaria {
  id              String   @id @default(uuid())
  maquinaId       String
  tareaId         String   // Obligatorio segun regla
  fincaId         String
  loteId          String?
  operador        String
  fechaInicio     DateTime
  fechaFin        DateTime
  horasUso        Float
  horometroInicio Float?
  horometroFin    Float?
  observaciones   String?  @db.Text
  createdAt       DateTime @default(now())

  maquina         Maquinaria @relation(fields: [maquinaId], references: [id])
  tarea           Tarea      @relation(fields: [tareaId], references: [id])
  finca           Finca      @relation(fields: [fincaId], references: [id])
  lote            Lote?      @relation(fields: [loteId], references: [id])
}

// -----------------------------------------------------------------------------
// 6) ALMACÉN E INVENTARIO
// -----------------------------------------------------------------------------
model Producto {
  id              String   @id @default(uuid())
  fincaId         String
  codigo          String   // PRO-000001 (Unique per Finca? Or Global? Keeping global uniqueness for simplicity for now, or composite unique)
  // Plan didn't specify changing codigo uniqueness, but ideally it should be unique per Finca if we want total isolation.
  // For now, I'll keep the @unique on codigo but note that it might collide if different fincas generate same sequence.
  // Ideally: @@unique([fincaId, codigo]) and remove @unique from codigo.
  // But let's stick to adding fincaId first. The code generation logic is "count + 1", which needs to filter by finca now.

  nombre          String
  categoria       String
  unidadMedida    String
  stockActual     Float    @default(0)
  activo          Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  finca           Finca    @relation(fields: [fincaId], references: [id])
  movimientos     MovimientoInventario[]

  @@unique([fincaId, codigo])
}

model MovimientoInventario {
  id              String   @id @default(uuid())
  fincaId         String
  productoId      String
  tipoMovimiento  TipoMovimiento
  fecha           DateTime
  cantidad        Float
  costoUnitario   Float?
  referencia      String // Compra, Ajuste, Traslado, Consumo
  tareaId         String? // Obligatorio si es consumo por tarea
  loteId          String?
  observaciones   String?  @db.Text
  createdAt       DateTime @default(now())

  finca           Finca    @relation(fields: [fincaId], references: [id])
  producto        Producto @relation(fields: [productoId], references: [id])
  tarea           Tarea?   @relation(fields: [tareaId], references: [id])
  lote            Lote?    @relation(fields: [loteId], references: [id])
}

enum TipoMovimiento {
  ENTRADA
  SALIDA
  AJUSTE
}

// -----------------------------------------------------------------------------
// 7) CONFIGURACION GENERAL
// -----------------------------------------------------------------------------

model TipoActividad {
  id        String   @id @default(uuid())
  nombre    String   @unique
}

model Responsable {
  id        String   @id @default(uuid())
  nombre    String   @unique
  email     String?
  celular   String?
  password  String   @default("123456")
  cargo     String? // Deprecated, kept for history
  cargoId   String?
  cargoRef  Cargo?   @relation(fields: [cargoId], references: [id])
  activo    Boolean  @default(true)
}

model Cargo {
  id        String       @id @default(uuid())
  nombre    String       @unique
  responsables Responsable[]
}

// -----------------------------------------------------------------------------
// 10) CATALOGOS ALMACÉN
// -----------------------------------------------------------------------------
model NombreProducto {
  id          String   @id @default(uuid())
  nombre      String   @unique
  categoriaId String?
  categoria   CategoriaProducto? @relation(fields: [categoriaId], references: [id])
}

model CategoriaProducto {
  id        String   @id @default(uuid())
  nombre    String   @unique
  nombres   NombreProducto[]
}

model UnidadMedida {
  id        String   @id @default(uuid())
  nombre    String   @unique
}

// -----------------------------------------------------------------------------
// 8) CATALOGOS CULTIVOS
// -----------------------------------------------------------------------------
model TipoCultivo {
  id          String            @id @default(uuid())
  nombre      String            @unique
  variedades  VariedadCultivo[]
}

model VariedadCultivo {
  id            String      @id @default(uuid())
  nombre        String
  tipoCultivoId String
  tipoCultivo   TipoCultivo @relation(fields: [tipoCultivoId], references: [id])

  @@unique([tipoCultivoId, nombre])
}

// -----------------------------------------------------------------------------
// 11) LOCATION CATALOGS
// -----------------------------------------------------------------------------
model Departamento {
  id        String      @id @default(uuid())
  nombre    String      @unique
  municipios Municipio[]
}

model Municipio {
  id              String       @id @default(uuid())
  nombre          String
  departamentoId  String
  departamento    Departamento @relation(fields: [departamentoId], references: [id])
}
